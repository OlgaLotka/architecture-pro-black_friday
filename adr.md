### <a name="_b7urdng99y53"></a>**Название задачи:**  Добавление новых категорий товаров в  «Мобильный мир»
### <a name="_hjk0fkfyohdk"></a>**Автор:** Лотка О.А.
### <a name="_uanumrh8zrui"></a>**Дата:** 23.07.2025
### <a name="_3bfxc9a45514"></a>**Функциональные требования**

### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**
| **№** | **Требование**                                                                                                                                                               |
|:-----:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|  F1   | Заказы. Быстрое создание заказов с одновременным списанием остатков                                                                                                          |
|  F2   | Заказы. Поиск истории заказов конкретного пользователя                                                                                                                       |
|  F3   | Заказы. Отображение статуса заказа                                                                                                                                           |
|  F4   | Товары. Частые обновления остатков при покупках.                                                                                                                             |
|  F5   | Товары. Поиск товаров по категориям и фильтрация по диапазону цен                                                                                                            |
|  F6   | Товары. Описание товара на странице продукта                                                                                                                                 |
|  F7   | Корзина. Создание корзины, когда заходит гость или новый пользователь. Получение текущей корзины по фильтру { session_id, status:"active" } или { user_id, status:"active" } |
|  F8   | Корзина. Добавление или замена товара в корзине                                                                                                                              |
|  F9   | Корзина. Удаление товара из корзины                                                                                                                                          |
|  F10  | Корзина. Слияние гостевой корзины в пользовательскую, если пользователь залогинится                                                                                          |
|  F11  | Корзина. Отметка корзины как заказанной                                                                                                                                      |

### <a name="_qmphm5d6rvi3"></a>**Решение**
[Диаграмма коллекций](task7.drawio)
Шардирование реализовать по геозоне для всех колекций.
Коллекция Товары (products). Диапазонное шардирование по цене - это позволит ускорить поиск по товарам
```shell
db.adminCommand({ shardCollection: "database.products", key: { "price": "price" },
    balancing: true,
    chunkMetadata: { shard: 'my-mongo-mongodb-sharded-shard-1', nChunks: 3 },
    chunks: [
      {
        min: { price: MinKey() },
        max: { price: 1000},
        'on shard': 'my-mongo-mongodb-sharded-shard-1',
        'last modified': Timestamp(2, 1)
      },
      {
        min: { price: 1001},
        max: { price: MaxKey() },
        'on shard': 'my-mongo-mongodb-sharded-shard-0',
        'last modified': Timestamp(0, 2)
      }
    ],
    tags: [
      { tag: 'TSR1', min: { price: MinKey() }, max: { price: 1000} },
      { tag: 'TSR2', min: { price: 1001 }, max: { price: MaxKey() } }
    ] })
```
Коллекция Заказы (orders) Хэшированное шардирование по идентификатору клиента - клиента позволит равномерно распределить данные
```shell
db.adminCommand({ shardCollection: "database.orders", key: { "clientId": "hashed" } })
```
### <a name="_bjrr7veeh80c"></a>**Метрики шардирования**
Метрики для отслеживания состояние шардов
<ul><li>CPU</li></ul>
<ul><li>RAM</li></ul>
<ul><li>среднее время ответа</li></ul>

Можно реализовать динамическое шардирования для горячих шардов по полю геозона
```shell
db.adminCommand({ shardCollection: "database.orders", key: { "geo_zone": "hashed",  "clientId": "hashed" }});
db.adminCommand({ shardCollection: "database.carts", key: { "geo_zone": "hashed" }});
```

|**№** | **Операция**                                                                        |  **Реплика**   | **Допустимая задержка** | **Обоснование**                                                                                                                                          |
|:----:|:------------------------------------------------------------------------------------|:--------------:|:-----------------------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------|
|  F1  | Заказы. Быстрое создание заказов с одновременным списанием остатков                 |    primary     |           1c            | Нужно обеспечить консистентность при списпннии остатков, чтобы избежать ситуации что 2 пользователяя заказали одну и ту же единицу товара                |
|  F2  | Заказы. Поиск истории заказов конкретного пользователя                              |   secondary    |           5c            | нет ничего критичного если пользователь увидит не совсем актуальную историю, обновит старницу и все станет правильным                                    |
|  F3  | Заказы. Отображение статуса заказа                                                  |   secondary    |           1c            | Важен актуальный статус, но можно например при оплате добавить плашку что статус обновляется после подтверждения от банка                                |
|  F4  | Товары. Частые обновления остатков при покупках.                                    |    primary     |          0,1c           | Сама критичная часть. Нужна строгая согласованность данных. чтобы не получилось что 2 пользователя заказали 1 и туже единицу и чтобы бухгалтерия сошлась |
|  F5  | Товары. Поиск товаров по категориям и фильтрация по диапазону цен                   |   secondary    |           5c            | Тут главное чтобы быстро поиск работал, а с какой ноды не принципиально                                                                                  |
|  F6  | Товары. Описание товара на странице продукта                                        |   secondary    |           5c            |                                                                                                                                                          |
|  F7  | Корзина. Создание корзины, когда заходит гость или новый пользователь.              |    primary     |           1c            | Важно чтобы состав корзины отображался корректно, чтобы пользователь не кликал 100 раз для добавления                                                    |
|  F8  | Корзина. Добавление или замена товара в корзине                                     |    primary     |           1c            | Важно чтобы состав корзины отображался корректно                                                                                                         |
|  F9  | Корзина. Удаление товара из корзины                                                 |    primary     |           1c            | Важно чтобы состав корзины отображался корректно                                                                                                         |
| F10  | Корзина. Слияние гостевой корзины в пользовательскую, если пользователь залогинится |    primary     |           1c            | Важно чтобы состав корзины отображался корректно                                                                                                         |
| F11  | Корзина. Отметка корзины как заказанной                                             |    primary     |           1c            | Важно чтобы состав корзины отображался корректно                                                                                                         |

### <a name="_bjrr7veeh80c"></a>**Переход на Cassandra **
Являются критически важными с точки зрения целостности и скорости обработки


|**№**|**Операция**| **Ключ для партиций** | **Стратегия**                       | **Обоснование**                                                                                                             |
|:---:|:------------------------------------------------------------------------------------|:---------------------:|:------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|
|F4|Обновление остатков|        геозона        | Read Repair,    Anti-Entropy Repair | Здесь нужен высокий уровень согласованности, чтобы нельзя было заказать несуществующий товар                                |
|F1|Быстрое создание заказов|        геозона        | Hinted Handoff, Read Repair              | Здесь нужен высокий уровень согласованности, но ниже чем в предыдущем пункте, нам нужна любая реплика с правильными данными |
|F5|Поиск товаров по категориям и фильтрация по диапазону цен |         цена          | Read Repair, Anti-Enropy Repair     | Нужен средний уровень согласованности потому что мы просто смотрим товар но очень выской уровень доступности данных         |

```shell
CREATE KEYSPACE MYKEYSPACE WITH REPLICATION = {
'class' : 'SimpleStrategy',
'replication_factor' : 3
};

CREATE TABLE products(
 id int,
 name text,
 category text,
 price int,
 count_id int,
 attr text
 PRIMARY KEY(id, (price))
) WITH CLUSTERING ORDER BY(price  DESC);
  
CREATE TABLE store(
 id int,
 count text,
 geo_zone text

 PRIMARY KEY(id, (geo_zone))
) WITH CLUSTERING ORDER BY(geo_zone  DESC); 
  
CREATE TABLE carts(
 id int,
 id_user,
 id_type text,
 id_product [],
 status text,
 create_date timestamp,
 update_date timestamp,
 delete_date timestamp,
 geo_zone text
 PRIMARY KEY(id, (geo_zone))
) WITH CLUSTERING ORDER BY(geo_zone  DESC);   
```
